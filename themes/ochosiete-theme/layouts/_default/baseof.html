<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode }}" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    <meta name="author" content="{{ .Site.Params.author }}">
    
    <!-- Open Graph -->
    <meta property="og:title" content="{{ if .Title }}{{ .Title }} • {{ end }}{{ .Site.Title }}">
    <meta property="og:description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    <meta property="og:type" content="{{ if .IsPage }}article{{ else }}website{{ end }}">
    <meta property="og:url" content="{{ .Permalink }}">
    {{ if .Params.image }}
    <meta property="og:image" content="{{ .Params.image | absURL }}">
    {{ end }}
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ if .Title }}{{ .Title }} • {{ end }}{{ .Site.Title }}">
    <meta name="twitter:description" content="{{ if .Description }}{{ .Description }}{{ else }}{{ .Site.Params.description }}{{ end }}">
    
    <title>{{ if .Title }}{{ .Title }} • {{ end }}{{ .Site.Title }}</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Styles -->
    {{ $css := resources.Get "css/main.css" }}
    <link rel="stylesheet" href="{{ $css.RelPermalink }}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="87">
    <link rel="apple-touch-icon" href="/images/pwa/icon-192x192.png">
    <meta name="theme-color" content="#C41E3A">
    <meta name="msapplication-TileColor" content="#C41E3A">
    <meta name="msapplication-TileImage" content="/images/pwa/icon-144x144.png">
    
    <!-- RSS -->
    {{ with .OutputFormats.Get "RSS" }}
    <link href="{{ .RelPermalink }}" rel="alternate" type="application/rss+xml" title="{{ $.Site.Title }}">
    {{ end }}
</head>
<body>
    <div class="site-container">
        {{ partial "header.html" . }}
        
        <main class="site-content">
            {{ block "main" . }}{{ end }}
        </main>
        
        {{ partial "footer.html" . }}
    </div>
    
    <!-- Dark Mode Toggle Script -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script>
        // Inicializar tema desde localStorage o preferencia del sistema
        const initTheme = () => {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
            return theme;
        };
        
        // Toggle tema
        const toggleTheme = () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        };
        
        // Inicializar al cargar
        initTheme();
        
        // Event listener para el botón
        document.addEventListener('DOMContentLoaded', () => {
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }
        });
    </script>
    
    <!-- Mobile Menu Script -->
    {{ $mobileMenu := resources.Get "js/mobile-menu.js" }}
    <script src="{{ $mobileMenu.RelPermalink }}" defer></script>
    
    <!-- Swipe Navigation Script -->
    {{ $swipeNav := resources.Get "js/swipe-navigation.js" }}
    <script src="{{ $swipeNav.RelPermalink }}" defer></script>
    
    <!-- Service Worker Registration (PWA) -->
    <script>
        // Registrar Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('[PWA] Service Worker registrado:', registration.scope);
                        
                        // Verificar actualizaciones cada hora
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000);
                        
                        // Detectar nueva versión disponible
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nueva versión disponible
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('[PWA] Error al registrar Service Worker:', error);
                    });
            });
            
            // Mostrar notificación de actualización
            function showUpdateNotification() {
                const notification = document.createElement('div');
                notification.innerHTML = `
                    <div style="position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background: var(--color-papel); border: 2px solid var(--color-acento); padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 9999; max-width: 90%; display: flex; align-items: center; gap: 1rem;">
                        <span style="font-family: var(--fuente-mono); font-size: 0.875rem; color: var(--color-texto);">
                            Nueva versión disponible
                        </span>
                        <button onclick="location.reload()" style="background: var(--color-acento); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">
                            Actualizar
                        </button>
                        <button onclick="this.parentElement.remove()" style="background: none; border: none; color: var(--color-texto-secundario); cursor: pointer; font-size: 1.25rem; padding: 0 0.5rem;">
                            ×
                        </button>
                    </div>
                `;
                document.body.appendChild(notification);
                
                // Auto-cerrar después de 10 segundos
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 10000);
            }
        }
        
        // Detectar cuando la app está siendo instalada
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir prompt automático
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar botón de instalación personalizado
            showInstallPrompt();
        });
        
        function showInstallPrompt() {
            const installBanner = document.createElement('div');
            installBanner.innerHTML = `
                <div id="install-banner" style="position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background: var(--color-acento); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 9999; max-width: 90%; display: flex; align-items: center; gap: 1rem; animation: slideUp 0.3s ease;">
                    <span style="font-family: var(--fuente-mono); font-size: 0.875rem; font-weight: 600;">
                        Instalar 87 en tu dispositivo
                    </span>
                    <button id="install-btn" style="background: white; color: var(--color-acento); border: none; padding: 0.5rem 1rem; border-radius: 4px; font-weight: 700; cursor: pointer; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">
                        Instalar
                    </button>
                    <button id="install-close" style="background: none; border: none; color: white; cursor: pointer; font-size: 1.25rem; padding: 0 0.5rem; opacity: 0.7;">
                        ×
                    </button>
                </div>
            `;
            document.body.appendChild(installBanner);
            
            // Event listeners
            document.getElementById('install-btn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('[PWA] Install prompt outcome:', outcome);
                    deferredPrompt = null;
                    document.getElementById('install-banner').remove();
                }
            });
            
            document.getElementById('install-close').addEventListener('click', () => {
                document.getElementById('install-banner').remove();
            });
            
            // Auto-cerrar después de 15 segundos
            setTimeout(() => {
                const banner = document.getElementById('install-banner');
                if (banner) {
                    banner.remove();
                }
            }, 15000);
        }
        
        // Detectar cuando la app fue instalada
        window.addEventListener('appinstalled', () => {
            console.log('[PWA] App instalada exitosamente');
            deferredPrompt = null;
        });
    </script>
    
    {{ block "scripts" . }}{{ end }}
</body>
</html>
